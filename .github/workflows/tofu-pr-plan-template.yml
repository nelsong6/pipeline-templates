name: OpenTofu PR Plan

on:
  workflow_call:
    inputs:
      working_directory:
        description: 'Directory containing OpenTofu files'
        required: false
        type: string
        default: './tofu'
      tofu_version:
        description: 'OpenTofu version'
        required: false
        type: string
        default: 'latest'
      azure_client_id:
        description: 'Azure Client ID (OIDC)'
        required: false
        type: string
        default: '043b35c3-f5de-4578-acd2-8b8f4c78f461'
      azure_tenant_id:
        description: 'Azure Tenant ID'
        required: false
        type: string
        default: '2236b5e4-81d2-4d82-bde5-17b1037999ea'
      azure_subscription_id:
        description: 'Azure Subscription ID'
        required: false
        type: string
        default: 'aee0cbd2-8074-4001-b610-0f8edb4eaa3c'

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  plan:
    name: OpenTofu Plan (PR Validation)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup OpenTofu
      uses: opentofu/setup-opentofu@v1
      with:
        tofu_version: ${{ inputs.tofu_version }}

    - name: Azure Login via OIDC
      uses: azure/login@v2
      with:
        client-id: ${{ inputs.azure_client_id }}
        tenant-id: ${{ inputs.azure_tenant_id }}
        subscription-id: ${{ inputs.azure_subscription_id }}

    - name: OpenTofu Init
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: tofu init

    - name: OpenTofu Validate
      run: tofu validate -no-color

    - name: OpenTofu Plan
      id: plan
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Run plan and capture output
        tofu plan -no-color 2>&1 | tee plan_output.txt
        
        # Check for errors
        if grep -q "Error:" plan_output.txt; then
          echo "❌ ERROR DETECTED in OpenTofu output!"
          cat plan_output.txt
          exit 1
        fi
        
        # Check for changes
        if grep -q "No changes. Your infrastructure matches the configuration." plan_output.txt; then
          echo "✅ No changes detected"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "⚠️ Changes detected"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
        
        # Store plan output for PR comment
        echo "PLAN_OUTPUT<<EOF" >> $GITHUB_ENV
        cat plan_output.txt >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Comment PR with Plan Results
      uses: actions/github-script@v7
      with:
        script: |
          const planOutput = process.env.PLAN_OUTPUT;
          const hasChanges = '${{ steps.plan.outputs.has_changes }}' === 'true';
          
          let body = '### OpenTofu Plan Results 豆腐\n\n';
          
          if (hasChanges) {
            body += '✅ **Plan successful** - Infrastructure changes detected\n\n';
            body += '**Next Steps:**\n';
            body += '1. Review the plan output below\n';
            body += '2. Merge this PR to enable production deployment\n';
            body += '3. Use the **Tofu Production Deploy** workflow to apply changes\n\n';
          } else {
            body += '✅ **Plan successful** - No infrastructure changes detected\n\n';
          }
          
          body += '<details>\n<summary>Show Plan Output</summary>\n\n```hcl\n';
          body += planOutput.slice(0, 60000); // Truncate if too long
          body += '\n```\n</details>';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
