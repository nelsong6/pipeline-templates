# .github/workflows/deploy-template.yml (in your central repo)
name: Universal Azure Deploy Template

on:
  workflow_call:
    inputs:
      target_sha:
        description: 'The commit SHA to deploy'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  REGISTRY: ghcr.io
  # github.repository will resolve to the caller's repo (e.g., nelsong6/kill-me)
  IMAGE_NAME: ${{ github.repository }}/workout-api 

jobs:
  # ============================================================================
  # JOB 1: BACKEND DEPLOYMENT
  # ============================================================================
  deploy-backend:
    name: Deploy Backend API
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for Phase 1 CI Build
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ inputs.target_sha }}
          check-name: 'build-pipeline / Build and Push Backend' 
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 15 
          allowed-conclusions: success,skipped

      - name: Install spacectl
        uses: spacelift-io/setup-spacectl@v1

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Fetch Spacelift Credentials from Key Vault
        run: |
          KV_ID=$(az keyvault secret show --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" --name spacelift-api-key-id --query value -o tsv)
          echo "::add-mask::$KV_ID"
          echo "SPACELIFT_API_KEY_ID=$KV_ID" >> $GITHUB_ENV

          KV_SECRET=$(az keyvault secret show --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" --name spacelift-api-key-secret --query value -o tsv)
          echo "::add-mask::$KV_SECRET"
          echo "SPACELIFT_API_KEY_SECRET=$KV_SECRET" >> $GITHUB_ENV

      - name: Fetch Backend Outputs
        env:
          SPACELIFT_API_KEY_ENDPOINT: 'https://nelsong6.app.us.spacelift.io'
        run: |
          APP_STACK_ID=${GITHUB_REPOSITORY#*/}
          
          INFRA_OUTPUTS=$(spacectl stack outputs --id infra-bootstrap --output json)
          echo "VITE_AUTH0_DOMAIN=https://$(echo "$INFRA_OUTPUTS" | jq -r '.[] | select(.id == "auth0_domain") | .value | fromjson')" >> $GITHUB_ENV
          echo "ACA_ENVIRONMENT_NAME=$(echo "$INFRA_OUTPUTS" | jq -r '.[] | select(.id == "container_app_environment_name") | .value | fromjson')" >> $GITHUB_ENV
          
          APP_OUTPUTS=$(spacectl stack outputs --id "$APP_STACK_ID" --output json)
          echo "VITE_AUTH0_CLIENT_ID=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "auth0_client_id") | .value | fromjson')" >> $GITHUB_ENV
          echo "VITE_AUTH0_AUDIENCE=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "auth0_audience") | .value | fromjson')" >> $GITHUB_ENV
          echo "CONTAINER_APP_NAME=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "container_app_name") | .value | fromjson')" >> $GITHUB_ENV
          echo "RESOURCE_GROUP_NAME=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "resource_group_name") | .value | fromjson')" >> $GITHUB_ENV
          
          RAW_URL=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "backend_api_url") | .value | fromjson')
          echo "BACKEND_HOSTNAME=${RAW_URL#https://}" >> $GITHUB_ENV

      - name: Deploy to Container App
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.target_sha }}

      - name: Bind Custom Domain & Generate Certificate
        run: |
          az containerapp hostname bind \
            --hostname ${{ env.BACKEND_HOSTNAME }} \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --environment ${{ env.ACA_ENVIRONMENT_NAME }} \
            --validation-method CNAME

  # ============================================================================
  # JOB 2: FRONTEND DEPLOYMENT
  # ============================================================================
  deploy-frontend:
    name: Deploy React Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use the input passed from the caller
          ref: ${{ inputs.target_sha }}

      - name: Install spacectl
        uses: spacelift-io/setup-spacectl@v1

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Fetch Spacelift Credentials from Key Vault
        run: |
          KV_ID=$(az keyvault secret show --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" --name spacelift-api-key-id --query value -o tsv)
          echo "::add-mask::$KV_ID"
          echo "SPACELIFT_API_KEY_ID=$KV_ID" >> $GITHUB_ENV

          KV_SECRET=$(az keyvault secret show --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" --name spacelift-api-key-secret --query value -o tsv)
          echo "::add-mask::$KV_SECRET"
          echo "SPACELIFT_API_KEY_SECRET=$KV_SECRET" >> $GITHUB_ENV

      - name: Fetch Frontend Outputs
        env:
          SPACELIFT_API_KEY_ENDPOINT: 'https://nelsong6.app.us.spacelift.io'
        run: |
          APP_STACK_ID=${GITHUB_REPOSITORY#*/}
          
          INFRA_OUTPUTS=$(spacectl stack outputs --id infra-bootstrap --output json)
          echo "VITE_AUTH0_DOMAIN=https://$(echo "$INFRA_OUTPUTS" | jq -r '.[] | select(.id == "auth0_domain") | .value | fromjson')" >> $GITHUB_ENV
          
          APP_OUTPUTS=$(spacectl stack outputs --id "$APP_STACK_ID" --output json)
          echo "VITE_API_URL=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "backend_api_url") | .value | fromjson')" >> $GITHUB_ENV
          echo "VITE_AUTH0_CLIENT_ID=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "auth0_client_id") | .value | fromjson')" >> $GITHUB_ENV
          echo "VITE_AUTH0_AUDIENCE=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "auth0_audience") | .value | fromjson')" >> $GITHUB_ENV
          echo "STATIC_WEB_APP_NAME=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "static_web_app_name") | .value | fromjson')" >> $GITHUB_ENV
          echo "RESOURCE_GROUP_NAME=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "resource_group_name") | .value | fromjson')" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Build Frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: Get Static Web App Deployment Token
        id: static-web-app-token
        run: |
          TOKEN=$(az staticwebapp secrets list --name ${{ env.STATIC_WEB_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP_NAME }} --query "properties.apiKey" -o tsv)
          echo "::add-mask::$TOKEN"
          echo "deployment_token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Deploy to Azure Static Web App
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.static-web-app-token.outputs.deployment_token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "./frontend/dist"
          output_location: ""
          skip_app_build: true
