name: Generate Local .env Files

on:
  workflow_call:
    inputs:
      spacelift_endpoint:
        description: 'The Spacelift instance URL'
        required: false
        type: string
        default: 'https://nelsong6.app.us.spacelift.io'
      azure_client_id:
        description: 'Azure Client ID (OIDC)'
        required: false
        type: string
        default: '043b35c3-f5de-4578-acd2-8b8f4c78f461'
      azure_tenant_id:
        description: 'Azure Tenant ID'
        required: false
        type: string
        default: '2236b5e4-81d2-4d82-bde5-17b1037999ea'
      azure_subscription_id:
        description: 'Azure Subscription ID'
        required: false
        type: string
        default: 'aee0cbd2-8074-4001-b610-0f8edb4eaa3c'

  workflow_dispatch:
    inputs:
      azure_client_id:
        description: 'Azure Client ID (OIDC)'
        required: false
        type: string
        default: '043b35c3-f5de-4578-acd2-8b8f4c78f461'
      azure_tenant_id:
        description: 'Azure Tenant ID'
        required: false
        type: string
        default: '2236b5e4-81d2-4d82-bde5-17b1037999ea'
      azure_subscription_id:
        description: 'Azure Subscription ID'
        required: false
        type: string
        default: 'aee0cbd2-8074-4001-b610-0f8edb4eaa3c'
    
permissions:
  id-token: write
  contents: read

jobs:
  generate-env:
    name: Generate .env Artifact
    runs-on: ubuntu-latest

    steps:
      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ inputs.azure_client_id || '043b35c3-f5de-4578-acd2-8b8f4c78f461' }}
          tenant-id: ${{ inputs.azure_tenant_id || '2236b5e4-81d2-4d82-bde5-17b1037999ea' }}
          subscription-id: ${{ inputs.azure_subscription_id || 'aee0cbd2-8074-4001-b610-0f8edb4eaa3c' }}

      - name: Fetch Spacelift Credentials from Key Vault
        run: |
          set -euo pipefail

          RAW_ID=$(az keyvault secret show --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" --name spacelift-api-key-id --query value -o tsv)
          KV_ID=$(echo "$RAW_ID" | tr -d '\r\n')
          echo "::add-mask::$KV_ID"
          echo "SPACELIFT_API_KEY_ID=$KV_ID" >> $GITHUB_ENV

          RAW_SECRET=$(az keyvault secret show --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" --name spacelift-api-key-secret --query value -o tsv)
          KV_SECRET=$(echo "$RAW_SECRET" | tr -d '\r\n')
          echo "::add-mask::$KV_SECRET"
          echo "SPACELIFT_API_KEY_SECRET=$KV_SECRET" >> $GITHUB_ENV

      - name: Setup Spacelift CLI
        uses: spacelift-io/setup-spacectl@v1

      - name: Fetch Outputs & Generate Files
        env:
          SPACELIFT_API_KEY_ENDPOINT: ${{ inputs.spacelift_endpoint || 'https://nelsong6.app.us.spacelift.io' }}
        run: |
          set -euo pipefail
          APP_STACK_ID=${GITHUB_REPOSITORY#*/}

          echo "Fetching outputs from infra-bootstrap..."
          # Fetch all outputs as a JSON array
          INFRA_OUTPUTS=$(spacectl stack outputs --id infra-bootstrap --output json)
          
          # Extract specific keys and decode them to raw text
          AUTH0_DOMAIN=$(echo "$INFRA_OUTPUTS" | jq -r '.[] | select(.id == "auth0_domain") | .value | fromjson')
          APP_CONFIG_ENDPOINT=$(echo "$INFRA_OUTPUTS" | jq -r '.[] | select(.id == "azure_app_config_endpoint") | .value | fromjson')
          TENANT_ID=$(echo "$INFRA_OUTPUTS" | jq -r '.[] | select(.id == "azure_tenant_id") | .value | fromjson')

          echo "Fetching outputs from app stack: $APP_STACK_ID..."
          APP_OUTPUTS=$(spacectl stack outputs --id "$APP_STACK_ID" --output json)
          
          AUTH0_CLIENT_ID=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "auth0_client_id") | .value | fromjson')
          AUTH0_AUDIENCE=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "auth0_audience") | .value | fromjson')
          APP_PREFIX=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "app_config_prefix") | .value | fromjson')

          mkdir -p env-files/frontend env-files/backend

          echo "Writing frontend/.env..."
          echo "VITE_API_URL=http://localhost:3000" > env-files/frontend/.env
          echo "VITE_AUTH0_DOMAIN=https://$AUTH0_DOMAIN" >> env-files/frontend/.env
          echo "VITE_AUTH0_CLIENT_ID=$AUTH0_CLIENT_ID" >> env-files/frontend/.env
          echo "VITE_AUTH0_AUDIENCE=$AUTH0_AUDIENCE" >> env-files/frontend/.env

          echo "Writing backend/.env..."
          echo "AZURE_APP_CONFIG_ENDPOINT=$APP_CONFIG_ENDPOINT" > env-files/backend/.env
          echo "APP_CONFIG_PREFIX=$APP_PREFIX" >> env-files/backend/.env
          echo "AZURE_TENANT_ID=$TENANT_ID" >> env-files/backend/.env

          echo "âœ… Files successfully generated."

      - name: Upload .env Artifact
        uses: actions/upload-artifact@v4
        with:
          name: local-env-files
          path: env-files/
          retention-days: 1
          include-hidden-files: true
