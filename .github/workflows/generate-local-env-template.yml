name: Generate Local .env Files

on:
  workflow_call:
    inputs:
      spacelift_endpoint:
        description: 'The Spacelift instance URL'
        required: false
        type: string
        default: 'https://nelsong6.app.us.spacelift.io'

  workflow_dispatch:
    
permissions:
  id-token: write
  contents: read

jobs:
  generate-env:
    name: Generate .env Artifact
    runs-on: ubuntu-latest

    steps:
      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ vars.ARM_CLIENT_ID }}
          tenant-id: ${{ vars.ARM_TENANT_ID }}
          subscription-id: ${{ vars.ARM_SUBSCRIPTION_ID }}

      - name: Fetch Spacelift Credentials from Key Vault
        run: |
          set -euo pipefail

          RAW_ID=$(az keyvault secret show --vault-name "${{ vars.KEY_VAULT_NAME }}" --name spacelift-api-key-id --query value -o tsv)
          KV_ID=$(echo "$RAW_ID" | tr -d '\r\n')
          echo "::add-mask::$KV_ID"
          echo "SPACELIFT_API_KEY_ID=$KV_ID" >> $GITHUB_ENV

          RAW_SECRET=$(az keyvault secret show --vault-name "${{ vars.KEY_VAULT_NAME }}" --name spacelift-api-key-secret --query value -o tsv)
          KV_SECRET=$(echo "$RAW_SECRET" | tr -d '\r\n')
          echo "::add-mask::$KV_SECRET"
          echo "SPACELIFT_API_KEY_SECRET=$KV_SECRET" >> $GITHUB_ENV

      - name: Setup Spacelift CLI
        uses: spacelift-io/setup-spacectl@v1

      - name: Fetch Outputs & Generate Files
        env:
          SPACELIFT_API_KEY_ENDPOINT: ${{ inputs.spacelift_endpoint || 'https://nelsong6.app.us.spacelift.io' }}
        run: |
          set -euo pipefail
          APP_STACK_ID=${GITHUB_REPOSITORY#*/}

          echo "Fetching outputs from infra-bootstrap..."
          # Fetch all outputs as a JSON array
          INFRA_OUTPUTS=$(spacectl stack outputs --id infra-bootstrap --output json)
          
          # Extract specific keys and decode them to raw text
          AUTH0_DOMAIN=$(echo "$INFRA_OUTPUTS" | jq -r '.[] | select(.id == "auth0_domain") | .value | fromjson')
          APP_CONFIG_ENDPOINT=$(echo "$INFRA_OUTPUTS" | jq -r '.[] | select(.id == "azure_app_config_endpoint") | .value | fromjson')
          TENANT_ID=$(echo "$INFRA_OUTPUTS" | jq -r '.[] | select(.id == "arm_tenant_id") | .value | fromjson')

          echo "Fetching outputs from app stack: $APP_STACK_ID..."
          APP_OUTPUTS=$(spacectl stack outputs --id "$APP_STACK_ID" --output json)
          
          AUTH0_CLIENT_ID=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "auth0_client_id") | .value | fromjson')
          AUTH0_AUDIENCE=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "auth0_audience") | .value | fromjson')
          APP_PREFIX=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "app_config_prefix") | .value | fromjson')

          mkdir -p env-files/frontend env-files/backend

          echo "Writing frontend/config.js..."
          echo "export const CONFIG = {" > env-files/frontend/config.js
          echo "  auth0Domain: \"$AUTH0_DOMAIN\"," >> env-files/frontend/config.js
          echo "  auth0ClientId: \"$AUTH0_CLIENT_ID\"," >> env-files/frontend/config.js
          echo "  auth0Audience: \"$AUTH0_AUDIENCE\"," >> env-files/frontend/config.js
          echo "  apiUrl: \"http://localhost:3000\"," >> env-files/frontend/config.js
          echo "};" >> env-files/frontend/config.js

          echo "Writing backend/.env..."
          echo "AZURE_APP_CONFIG_ENDPOINT=$APP_CONFIG_ENDPOINT" > env-files/backend/.env
          echo "APP_CONFIG_PREFIX=$APP_PREFIX" >> env-files/backend/.env
          echo "AZURE_TENANT_ID=$TENANT_ID" >> env-files/backend/.env

          echo "âœ… Files successfully generated."

      - name: Upload .env Artifact
        uses: actions/upload-artifact@v4
        with:
          name: local-env-files
          path: env-files/
          retention-days: 1
          include-hidden-files: true
