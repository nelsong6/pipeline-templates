name: Shared Repository Linting

on:
  workflow_call:
    inputs:
      working_directory:
        description: 'Directory to check'
        required: false
        type: string
        default: '.'

permissions:
  contents: read

jobs:
  lint:
    name: Run Lint Checks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------------------------------
      # üìù Newline Check
      # ----------------------------------------------------------------
      - name: Check for trailing newlines
        run: |
          FAILED=0
          
          for file in $(git grep -Il ''); do
            if [ -s "$file" ] && [ "$(tail -c 1 "$file" | wc -l)" -eq 0 ]; then
              echo "‚ùå Missing trailing newline: $file"
              FAILED=1
            fi
          done
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "Some files are missing a trailing newline. Please add an empty line to the end of the files listed above."
            exit 1
          else
            echo "‚úÖ All text files end with a proper newline."
          fi

      # ----------------------------------------------------------------
      # üöÄ Future Check Placeholders
      # ----------------------------------------------------------------
      # - name: Check Markdown formatting
      #   run: |
      #     echo "Markdown linting goes here"
      
      # - name: Check Shell scripts (shellcheck)
      #   run: |
      #     echo "Shell script linting goes here"

      # ----------------------------------------------------------------
      # üõë YAML Extension Check
      # ----------------------------------------------------------------
      - name: Enforce .yml extension
        run: |
          # Fetch tracked files ending in .yaml
          YAML_FILES=$(git ls-files '*.yaml')
          
          if [ -n "$YAML_FILES" ]; then
            echo "‚ùå Found files with the '.yaml' extension. Please rename them to use '.yml' instead:"
            echo "$YAML_FILES"
            exit 1
          else
            echo "‚úÖ All YAML files use the correct '.yml' extension."
          fi

      # ----------------------------------------------------------------
      # üìñ Spell Check (Markdown files)
      # ----------------------------------------------------------------
      - name: Run cspell on Markdown
        run: |
          echo "Running spellcheck on all Markdown files..."
          # The --no-progress flag keeps the CI logs clean
          npx cspell "**/*.md" --no-progress
          

      - name: Run Markdown Lint
        run: |
          echo "Linting Markdown formatting..."
          npx markdownlint-cli "**/*.md" --ignore "node_modules"

      # ----------------------------------------------------------------
      # üìñ Spell Check (Markdown files)
      # ----------------------------------------------------------------
      - name: Run cspell on Markdown
        run: |
          echo "Running spellcheck on all Markdown files..."
          npx cspell "**/*.md" --no-progress

      - name: Run tofu fmt check
        id: fmt
        run: |
          echo "Running tofu fmt -recursive -check..."
          if tofu fmt -recursive -check; then
            echo "‚úÖ All OpenTofu files are properly formatted"
            exit 0
          else
            echo "‚ùå Format check failed. Please run 'tofu fmt -recursive' to fix formatting issues."
            echo ""
            echo "The following files need formatting:"
            # Use || true so the diff command doesn't crash the script before exiting 1
            tofu fmt -recursive -check -diff || true
            exit 1
          fi

      # ----------------------------------------------------------------
      # üìã Markdown Lint
      # ----------------------------------------------------------------
      - name: Run Markdown Lint
        run: |
          echo "Linting Markdown formatting..."
          npx markdownlint-cli "**/*.md" --ignore "node_modules"

      # ----------------------------------------------------------------
      # üî§ Filename Check (No Underscores)
      # ----------------------------------------------------------------
      - name: Enforce no underscores in filenames
        run: |
          # Add any filenames, directories, or patterns to ignore below.
          # Place one pattern per line.
          IGNORE_LIST=$(cat << 'EOF'
          PULL_REQUEST_TEMPLATE
          ISSUE_TEMPLATE
          EOF
          )
          
          # Automatically convert the multi-line list into a regex pattern (Pattern1|Pattern2)
          IGNORE_PATTERN=$(echo "$IGNORE_LIST" | grep -v '^$' | paste -sd '|' -)
          
          # If no files have underscores, exit successfully
          if [ -z "$UNDERSCORE_FILES" ]; then
            echo "‚úÖ All filenames are free of underscores."
            exit 0
          fi
          
          # Filter out the ignored files using the pattern above
          FAILED_FILES=$(echo "$UNDERSCORE_FILES" | grep -vE "$IGNORE_PATTERN" || true)
          
          # If any files are left in the list after filtering, fail the build
          if [ -n "$(echo "$FAILED_FILES" | grep -v '^$')" ]; then
            echo "‚ùå Found files with underscores in their names. Please rename them to use hyphens (-) instead:"
            echo "$FAILED_FILES"
            exit 1
          else
            echo "‚úÖ All non-ignored filenames are free of underscores."
          fi