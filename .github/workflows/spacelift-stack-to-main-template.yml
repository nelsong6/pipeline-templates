name: Shared Spacelift Branch Reset

on:
  workflow_call:
    inputs:
      spacelift_endpoint:
        description: 'The Spacelift instance URL (e.g., https://nelsong6.app.spacelift.io)'
        required: true
        type: string
      target_branch:
        description: 'The branch to reset the stack to'
        required: false
        type: string
        default: 'main'
      azure_client_id:
        description: 'Azure Client ID (OIDC)'
        required: false
        type: string
        default: '043b35c3-f5de-4578-acd2-8b8f4c78f461'
      azure_tenant_id:
        description: 'Azure Tenant ID'
        required: false
        type: string
        default: '2236b5e4-81d2-4d82-bde5-17b1037999ea'
      azure_subscription_id:
        description: 'Azure Subscription ID'
        required: false
        type: string
        default: 'aee0cbd2-8074-4001-b610-0f8edb4eaa3c'
  workflow_dispatch:
    inputs:
      spacelift_endpoint:
        description: 'The Spacelift instance URL'
        required: true
        type: string
        default: 'https://nelsong6.app.spacelift.io'
      target_branch:
        description: 'The branch to reset the stack to'
        required: false
        type: string
        default: 'main'
      azure_client_id:
        description: 'Azure Client ID (OIDC)'
        required: false
        type: string
        default: '043b35c3-f5de-4578-acd2-8b8f4c78f461'
      azure_tenant_id:
        description: 'Azure Tenant ID'
        required: false
        type: string
        default: '2236b5e4-81d2-4d82-bde5-17b1037999ea'
      azure_subscription_id:
        description: 'Azure Subscription ID'
        required: false
        type: string
        default: 'aee0cbd2-8074-4001-b610-0f8edb4eaa3c'

permissions:
  id-token: write
  contents: read

jobs:
  reset-branch:
    name: Reset Spacelift Tracked Branch
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ inputs.azure_client_id }}
          tenant-id: ${{ inputs.azure_tenant_id }}
          subscription-id: ${{ inputs.azure_subscription_id }}

      - name: Fetch Spacelift Credentials from Key Vault
        run: |
          KV_ID=$(az keyvault secret show --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" --name spacelift-api-key-id --query value -o tsv)
          echo "::add-mask::$KV_ID"
          echo "SPACELIFT_API_KEY_ID=$KV_ID" >> $GITHUB_ENV

          KV_SECRET=$(az keyvault secret show --vault-name "${{ vars.AZURE_KEY_VAULT_NAME }}" --name spacelift-api-key-secret --query value -o tsv)
          echo "::add-mask::$KV_SECRET"
          echo "SPACELIFT_API_KEY_SECRET=$KV_SECRET" >> $GITHUB_ENV

      - name: Setup Spacelift CLI (spacectl)
        uses: spacelift-io/setup-spacectl@v1

      - name: Update Stack Branch
        env:
          SPACELIFT_API_KEY_ENDPOINT: ${{ inputs.spacelift_endpoint }}
          STACK_ID: ${{ github.event.repository.name }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
        run: |
          echo "Targeting Spacelift stack: $STACK_ID"
          echo "Resetting tracked branch to: $TARGET_BRANCH"
          
          # spacectl reads the current state, patches the branch, and pushes it back
          spacectl stack update --id "$STACK_ID" --branch "$TARGET_BRANCH"
          echo "✅ Stack branch successfully updated."

          # Reconcile state by triggering a deployment
          echo "Triggering deployment on $TARGET_BRANCH..."
          spacectl stack deploy --id "$STACK_ID"
          echo "✅ Deployment triggered successfully."
