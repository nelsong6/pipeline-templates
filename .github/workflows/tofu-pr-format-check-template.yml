name: OpenTofu PR Format Check

on:
  workflow_call:
    inputs:
      tofu_version:
        description: 'OpenTofu version to use'
        required: false
        type: string
        default: 'latest'
      working_directory:
        description: 'Directory to run the format check in'
        required: false
        type: string
        default: '.'

permissions:
  contents: read
  pull-requests: write

jobs:
  tofu-format-check:
    name: OpenTofu Format Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ inputs.tofu_version }}

      - name: Run tofu fmt check
        id: fmt
        run: |
          echo "Running tofu fmt -recursive -check..."
          if tofu fmt -recursive -check; then
            echo "✅ All OpenTofu files are properly formatted"
            exit 0
          else
            echo "❌ Format check failed. Please run 'tofu fmt -recursive' to fix formatting issues."
            echo ""
            echo "The following files need formatting:"
            # Use || true so the diff command doesn't crash the script before exiting 1
            tofu fmt -recursive -check -diff || true
            exit 1
          fi

      - name: Comment PR on failure
        if: failure() && steps.fmt.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ❌ OpenTofu Format Check Failed
              
              The OpenTofu format check has failed. Please run the following command to fix formatting issues:
              
              \`\`\`bash
              tofu fmt -recursive
              \`\`\`
              
              Then commit and push the changes.`
            })