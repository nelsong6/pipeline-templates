name: Universal Spacelift Pipeline

on:
  workflow_call:
    inputs:
      spacelift_endpoint:
        description: 'Spacelift account endpoint (e.g., https://your-account.app.spacelift.io)'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  spacelift-execution:
    name: Spacelift Infrastructure Run
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install spacectl
      uses: spacelift-io/setup-spacectl@v1

    - name: Authenticate to Spacelift via OIDC
      run: |
        spacectl profile create oidc-profile \
          --endpoint ${{ inputs.spacelift_endpoint }} \
          --type github

    - name: Execute Spacelift Run
      run: |
        APP_STACK_ID=${GITHUB_REPOSITORY#*/}
        
        # 1. Pull Requests -> Proposed Run (Plan Only)
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "Triggering Proposed Run (Plan) in Spacelift for PR..."
          
          # We pass the PR's specific commit SHA and --tail to stream logs back to GitHub
          spacectl stack propose \
            --id $APP_STACK_ID \
            --sha ${{ github.event.pull_request.head.sha }} \
            --tail
        
        # 2. Main Branch Pushes -> Tracked Run (Plan & Apply)
        else
          echo "Triggering Tracked Run (Apply) in Spacelift for main branch..."
          
          # Tracked runs will execute the plan, and if auto-approve is on, apply it immediately
          spacectl stack deploy \
            --id $APP_STACK_ID \
            --sha ${{ github.sha }} \
            --tail
        fi
